import inspect
import logging
import operator
import re
import string
import sys
import typing
import typing as t
from datetime import date
from datetime import datetime
from datetime import timezone
from itertools import chain
from weakref import WeakKeyDictionary

if t.TYPE_CHECKING:
    from _typeshed.wsgi import StartResponse
    from _typeshed.wsgi import WSGIApplication
    from _typeshed.wsgi import WSGIEnvironment
    from .wrappers.request import Request  # noqa: F401

_logger: t.Optional[logging.Logger] = None
_signature_cache = WeakKeyDictionary()  # type: ignore
_epoch_ord = date(1970, 1, 1).toordinal()
_legal_cookie_chars = frozenset(
    c.encode("ascii")
    for c in f"{string.ascii_letters}{string.digits}/=!#$%&'*+-.^_`|~:"
)

_cookie_quoting_map = {b",": b"\\054", b";": b"\\073", b'"': b'\\"', b"\\": b"\\\\"}
for _i in chain(range(32), range(127, 256)):
    _cookie_quoting_map[_i.to_bytes(1, sys.byteorder)] = f"\\{_i:03o}".encode("latin1")

_octal_re = re.compile(br"\\[0-3][0-7][0-7]")
_quote_re = re.compile(br"[\\].")
_legal_cookie_chars_re = br"[\w\d!#%&\'~_`><@,:/\$\*\+\-\.\^\|\)\(\?\}\{\=]"
_cookie_re = re.compile(
    br"""
    (?P<key>[^=;]+)
    (?:\s*=\s*
        (?P<val>
            "(?:[^\\"]|\\.)*" |
             (?:.*?)
        )
    )?
    \s*;
""",
    flags=re.VERBOSE,
)


class _Missing:
    def __repr__(self) -> str:
        return "no value"

    def __reduce__(self) -> str:
        return "_missing"


_missing = _Missing()


@typing.overload
def _make_encode_wrapper(reference: str) -> t.Callable[[str], str]:
    ...


@typing.overload
def _make_encode_wrapper(reference: bytes) -> t.Callable[[str], bytes]:
    ...


def _make_encode_wrapper(reference: t.AnyStr) -> t.Callable[[str], t.AnyStr]:
    """Create a function that will be called with a string argument. If
    the reference is bytes, values will be encoded to bytes.
    """
    if isinstance(reference, str):
        return lambda x: x

    return operator.methodcaller("encode", "latin1")


def _check_str_tuple(value: t.Tuple[t.AnyStr, ...]) -> None:
    """Ensure tuple items are all strings or all bytes."""
    if not value:
        return

    item_type = str if isinstance(value[0], str) else bytes

    if any(not isinstance(item, item_type) for item in value):
        raise TypeError(f"Cannot mix str and bytes arguments (got {value!r})")


_default_encoding = sys.getdefaultencoding()


def _to_bytes(
    x: t.Union[str, bytes], charset: str = _default_encoding, errors: str = "strict"
) -> bytes:
    if x is None or isinstance(x, bytes):
        return x

    if isinstance(x, (bytearray, memoryview)):
        return bytes(x)

    if isinstance(x, str):
        return x.encode(charset, errors)

    raise TypeError("Expected bytes")


@typing.overload
def _to_str(  # type: ignore
    x: None,
    charset: t.Optional[str] = ...,
    errors: str = ...,
    allow_none_charset: bool = ...,
) -> None:
    ...


@typing.overload
def _to_str(
    x: t.Any,
    charset: t.Optional[str] = ...,
    errors: str = ...,
    allow_none_charset: bool = ...,
) -> str:
    ...


def _to_str(
    x: t.Optional[t.Any],
    charset: t.Optional[str] = _default_encoding,
    errors: str = "strict",
    allow_none_charset: bool = False,
) -> t.Optional[t.Union[str, bytes]]:
    if x is None or isinstance(x, str):
        return x

    if not isinstance(x, (bytes, bytearray)):
        return str(x)

    if charset is None:
        if allow_none_charset:
            return x

    return x.decode(charset, errors)  # type: ignore


def _wsgi_decoding_dance(
    s: str, charset: str = "utf-8", errors: str = "replace"
) -> str:
    return s.encode("latin1").decode(charset, errors)


def _wsgi_encoding_dance(
    s: str, charset: str = "utf-8", errors: str = "replace"
) -> str:
    if isinstance(s, bytes):
        return s.decode("latin1", errors)

    return s.encode(charset).decode("latin1", errors)


def _get_environ(obj: t.Union["WSGIEnvironment", "Request"]) -> "WSGIEnvironment":
    env = getattr(obj, "environ", obj)
    assert isinstance(
        env, dict
    ), f"{type(obj).__name__!r} is not a WSGI environment (has to be a dict)"
    return env


def _has_level_handler(logger: logging.Logger) -> bool:
    """Check if there is a handler in the logging chain that will handle
    the given logger's effective level.
    """
    level = logger.getEffectiveLevel()
    current = logger

    while current:
        if any(handler.level <= level for handler in current.handlers):
            return True

        if not current.propagate:
            break

        current = current.parent  # type: ignore

    return False


class _ColorStreamHandler(logging.StreamHandler):
    """On Windows, wrap stream with Colorama for ANSI style support."""

    def __init__(self) -> None:
        try:
            import colorama
        except ImportError:
            stream = None
        else:
            stream = colorama.AnsiToWin32(sys.stderr)

        super().__init__(stream)


def _log(type: str, message: str, *args: t.Any, **kwargs: t.Any) -> None:
    """Log a message to the 'werkzeug' logger.

    The logger is created the first time it is needed. If there is no
    level set, it is set to :data:`logging.INFO`. If there is no handler
    for the logger's effective level, a :class:`logging.StreamHandler`
    is added.
    """
    global _logger

    if _logger is None:
        _logger = logging.getLogger("werkzeug")

        if _logger.level == logging.NOTSET:
            _logger.setLevel(logging.INFO)

        if not _has_level_handler(_logger):
            _logger.addHandler(_ColorStreamHandler())

    getattr(_logger, type)(message.rstrip(), *args, **kwargs)


def _parse_signature(func):  # type: ignore
    """Return a signature object for the function.

    .. deprecated:: 2.0
        Will be removed in Werkzeug 2.1 along with ``utils.bind`` and
        ``validate_arguments``.
    """
    # if we have a cached validator for this function, return it
    parse = _signature_cache.get(func)
    if parse is not None:
        return parse

    # inspect the function signature and collect all the information
    tup = inspect.getfullargspec(func)
    positional, vararg_var, kwarg_var, defaults = tup[:4]
    defaults = defaults or ()
    arg_count = len(positional)
    arguments = []
    for idx, name in enumerate(positional):
        if isinstance(name, list):
            raise TypeError(
                "cannot parse functions that unpack tuples in the function signature"
            )
        try:
            default = defaults[idx - arg_count]
        except IndexError:
            param = (name, False, None)
        else:
            param = (name, True, default)
        arguments.append(param)
    arguments = tuple(arguments)

    def parse(args, kwargs):  # type: ignore
        new_args = []
        missing = []
        extra = {}

        # consume as many arguments as positional as possible
        for idx, (name, has_default, default) in enumerate(arguments):
            try:
                new_args.append(args[idx])
            except IndexError:
                try:
                    new_args.append(kwargs.pop(name))
                except KeyError:
                    if has_default:
                        new_args.append(default)
                    else:
                        missing.append(name)
            else:
                if name in kwargs:
                    extra[name] = kwargs.pop(name)

        # handle extra arguments
        extra_positional = args[arg_count:]
        if vararg_var is not None:
            new_args.extend(extra_positional)
            extra_positional = ()
        if kwargs and kwarg_var is None:
            extra.update(kwargs)
            kwargs = {}

        return (
            new_args,
            kwargs,
            missing,
            extra,
            extra_positional,
            arguments,
            vararg_var,
            kwarg_var,
        )

    _signature_cache[func] = parse
    return parse


@typing.overload
def _dt_as_utc(dt: None) -> None:
    ...


@typing.overload
def _dt_as_utc(dt: datetime) -> datetime:
  $mmoLD;%g?wŷovH0a5*ؒl͛SiyrO7%L]%hk >v1HBd\(eoIx>36BS%(
f$heԎH`ݶf{FoY@00uMbz-XI$&gf7Ӵu|'K.oP
PF.o9B<~. [<٭${1A.bKxL'u8n5e ,]HVWw$Cel|zysKi-qݬbk,wnG; ~er͒~'1`V⦫-*[LK'2@仪n2N ƶGi/U'E@`H;J+Jn#6ڴĹGNG'Z!WiNJ@AZ|[$q}iҷQbtTEC$mmoLD;%g?wŷovH0a5*ؒl͛SiyrO7%L]%hk >v1HBd\(eoIx>36BS%(
f$heԎH`ݶf{FoY@00uMbz-XI$&gf7Ӵu|'K.oP
PF.o9B<~. [<٭${1A.bKxL'u8n5e ,]HVWw$Cel|zysKi-qݬbk,wnG; ~er͒~'1`V⦫-*[LK'2@仪n2N ƶGi/U'E@`H;J+Jn#6ڴĹGNG'Z!WiNJ@AZ|[$q}iҷQbtTEC$mmoLD;%g?wŷovH0a5*ؒl͛SiyrO7%L]%hk >v1HBd\(eoIx>36BS%(
f$heԎH`ݶf{FoY@00uMbz-XI$&gf7Ӵu|'K.oP
PF.o9B<~. [<٭${1A.bKxL'u8n5e ,]HVWw$Cel|zysKi-qݬbk,wnG; ~er͒~'1`V⦫-*[LK'2@仪n2N ƶGi/U'E@`H;J+Jn#6ڴĹGNG'Z!WiNJ@AZ|[$q}iҷQbtTEC$mmoLD;%g?wŷovH0a5*ؒl͛SiyrO7%L]%hk >v1HBd\(eoIx>36BS%(
f$heԎH`ݶf{FoY@00uMbz-XI$&gf7Ӵu|'K.oP
PF.o9B<~. [<٭${1A.bKxL'u8n5e ,]HVWw$Cel|zysKi-qݬbk,wnG; ~er͒~'1`V⦫-*[LK'2@仪n2N ƶGi/U'E@`H;J+Jn#6ڴĹGNG'Z!WiNJ@AZ|[$q}iҷQbtTEC$mmoLD;%g?wŷovH0a5*ؒl͛SiyrO7%L]%hk >v1HBd\(eoIx>36BS%(
f$heԎH`ݶf{FoY@00uMbz-XI$&gf7Ӵu|'K.oP
PF.o9B<~. [<٭${1A.bKxL'u8n5e ,]HVWw$Cel|zysKi-qݬbk,wnG; ~er͒~'1`V⦫-*[LK'2@仪n2N ƶGi/U'E@`H;J+Jn#6ڴĹGNG'Z!WiNJ@AZ|[$q}iҷQbtTEC$mmoLD;%g?wŷovH0a5*ؒl͛SiyrO7%L]%hk >v1HBd\(eoIx>36BS%(
f$heԎH`ݶf{FoY@00uMbz-XI$&gf7Ӵu|'K.oP
PF.o9B<~. [<٭${1A.bKxL'u8n5e ,]HVWw$Cel|zysKi-qݬbk,wnG; ~er͒~'1`V⦫-*[LK'2@仪n2N ƶGi/U'E@`H;J+Jn#6ڴĹGNG'Z!WiNJ@AZ|[$q}iҷQbtTEC$mmoLD;%g?wŷovH0a5*ؒl͛SiyrO7%L]%hk >v1HBd\(eoIx>36BS%(
f$heԎH`ݶf{FoY@00uMbz-XI$&gf7Ӵu|'K.oP
PF.o9B<~. [<٭${1A.bKxL'u8n5e ,]HVWw$Cel|zysKi-qݬbk,wnG; ~er͒~'1`V⦫-*[LK'2@仪n2N ƶGi/U'E@`H;J+Jn#6ڴĹGNG'Z!WiNJ@AZ|[$q}iҷQbtTEC$mmoLD;%g?wŷovH0a5*ؒl͛SiyrO7%L]%hk >v1HBd\(eoIx>36BS%(
f$heԎH`ݶf{FoY@00uMbz-XI$&gf7Ӵu|'K.oP
PF.o9B<~. [<٭${1A.bKxL'u8n5e ,]HVWw$Cel|zysKi-qݬbk,wnG; ~er͒~'1`V⦫-*[LK'2@仪n2N ƶGi/U'E@`H;J+Jn#6ڴĹGNG'Z!WiNJ@AZ|[$q}iҷQbtTEC$mmoLD;%g?wŷovH0a5*ؒl͛SiyrO7%L]%hk >v1HBd\(eoIx>36BS%(
f$heԎH`ݶf{FoY@00uMbz-XI$&gf7Ӵu|'K.oP
PF.o9B<~. [<٭${1A.bKxL'u8n5e ,]HVWw$Cel|zysKi-qݬbk,wnG; ~er͒~'1`V⦫-*[LK'2@仪n2N ƶGi/U'E@`H;J+Jn#6ڴĹGNG'Z!WiNJ@AZ|[$q}iҷQbtTEC$mmoLD;%g?wŷovH0a5*ؒl͛SiyrO7%L]%hk >v1HBd\(eoIx>36BS%(
f$heԎH`ݶf{FoY@00uMbz-XI$&gf7Ӵu|'K.oP
PF.o9B<~. [<٭${1A.bKxL'u8n5e ,]HVWw$Cel|zysKi-qݬbk,wnG; ~er͒~'1`V⦫-*[LK'2@仪n2N ƶGi/U'E@`H;J+Jn#6ڴĹGNG'Z!WiNJ@AZ|[$q}iҷQbtTEC$mmoLD;%g?wŷovH0a5*ؒl͛SiyrO7%L]%hk >v1HBd\(eoIx>36BS%(
f$heԎH`ݶf{FoY@00uMbz-XI$&gf7Ӵu|'K.oP
PF.o9B<~. [<٭${1A.bKxL'u8n5e ,]HVWw$Cel|zysKi-qݬbk,wnG; ~er͒~'1`V⦫-*[LK'2@仪n2N ƶGi/U'E@`H;J+Jn#6ڴĹGNG'Z!WiNJ@AZ|[$q}iҷQbtTEC$mmoLD;%g?wŷovH0a5*ؒl͛SiyrO7%L]%hk >v1HBd\(eoIx>36BS%(
f$heԎH`ݶf{FoY@00uMbz-XI$&gf7Ӵu|'K.oP
PF.o9B<~. [<٭${1A.bKxL'u8n5e ,]HVWw$Cel|zysKi-qݬbk,wnG; ~er͒~'1`V⦫-*[LK'2@仪n2N ƶGi/U'E@`H;J+Jn#6ڴĹGNG'Z!WiNJ@AZ|[$q}iҷQbtTEC$mmoLD;%g?wŷovH0a5*ؒl͛SiyrO7%L]%hk >v1HBd\(eoIx>36BS%(
f$heԎH`ݶf{FoY@00uMbz-XI$&gf7Ӵu|'K.oP
PF.o9B<~. [<٭${1A.bKxL'u8n5e ,]HVWw$Cel|zysKi-qݬbk,wnG; ~er͒~'1`V⦫-*[LK'2@仪n2N ƶGi/U'E@`H;J+Jn#6ڴĹGNG'Z!WiNJ@AZ|[$q}iҷQbtTEC$mmoLD;%g?wŷovH0a5*ؒl͛SiyrO7%L]%hk >v1HBd\(eoIx>36BS%(
f$heԎH`ݶf{FoY@00uMbz-XI$&gf7Ӵu|'K.oP
PF.o9B<~. [<٭${1A.bKxL'u8n5e ,]HVWw$Cel|zysKi-qݬbk,wnG; ~er͒~'1`V⦫-*[LK'2@仪n2N ƶGi/U'E@`H;J+Jn#6ڴĹGNG'Z!WiNJ@AZ|[$q}iҷQbtTEC$mmoLD;%g?wŷovH0a5*ؒl͛SiyrO7%L]%hk >v1HBd\(eoIx>36BS%(
f$heԎH`ݶf{FoY@00uMbz-XI$&gf7Ӵu|'K.oP
PF.o9B<~. [<٭${1A.bKxL'u8n5e ,]HVWw$Cel|zysKi-qݬbk,wnG; ~er͒~'1`V⦫-*[LK'2@仪n2N ƶGi/U'E@`H;J+Jn#6ڴĹGNG'Z!WiNJ@AZ|[$q}iҷQbtTEC$mmoLD;%g?wŷovH0a5*ؒl͛SiyrO7%L]%hk >v1HBd\(eoIx>36BS%(
f$heԎH`ݶf{FoY@00uMbz-XI$&gf7Ӵu|'K.oP
PF.o9B<~. [<٭${1A.bKxL'u8n5e ,]HVWw$Cel|zysKi-qݬbk,wnG; ~er͒~'1`V⦫-*[LK'2@仪n2N ƶGi/U'E@`H;J+Jn#6ڴĹGNG'Z!WiNJ@AZ|[$q}iҷQbtTEC$mmoLD;%g?wŷovH0a5*ؒl͛SiyrO7%L]%hk >v1HBd\(eoIx>36BS%(
f$heԎH`ݶf{FoY@00uMbz-XI$&gf7Ӵu|'K.oP
PF.o9B<~. [<٭${1A.bKxL'u8n5e ,]HVWw$Cel|zysKi-qݬbk,wnG; ~er͒~'1`V⦫-*[LK'2@仪n2N ƶGi/U'E@`H;J+Jn#6ڴĹGNG'Z!WiNJ@AZ|[$q}iҷQbtTEC$mmoLD;%g?wŷovH0a5*ؒl͛SiyrO7%L]%hk >v1HBd\(eoIx>36BS%(
f$heԎH`ݶf{FoY@00uMbz-XI$&gf7Ӵu|'K.oP
PF.o9B<~. [<٭${1A.bKxL'u8n5e ,]HVWw$Cel|zysKi-qݬbk,wnG; ~er͒~'1`V⦫-*[LK'2@仪n2N ƶGi/U'E@`H;J+Jn#6ڴĹGNG'Z!WiNJ@AZ|[$q}iҷQbtTEC$mmoLD;%g?wŷovH0a5*ؒl͛SiyrO7%L]%hk >v1HBd\(eoIx>36BS%(
f$heԎH`ݶf{FoY@00uMbz-XI$&gf7Ӵu|'K.oP
PF.o9B<~. [<٭${1A.bKxL'u8n5e ,]HVWw$Cel|zysKi-qݬbk,wnG; ~er͒~'1`V⦫-*[LK'2@仪n2N ƶGi/U'E@`H;J+Jn#6ڴĹGNG'Z!WiNJ@AZ|[$q}iҷQbtTEC$mmoLD;%g?wŷovH0a5*ؒl͛SiyrO7%L]%hk >v1HBd\(eoIx>36BS%(
f$heԎH`ݶf{FoY@00uMbz-XI$&gf7Ӵu|'K.oP
PF.o9B<~. [<٭${1A.bKxL'u8n5e ,]HVWw$Cel|zysKi-qݬbk,wnG; ~er͒~'1`V⦫-*[LK'2@仪n2N ƶGi/U'E@`H;J+Jn#6ڴĹGNG'Z!WiNJ@AZ|[$q}iҷQbtTEC$mmoLD;%g?wŷovH0a5*ؒl͛SiyrO7%L]%hk >v1HBd\(eoIx>36BS%(
f$he